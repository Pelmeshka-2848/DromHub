<Page
    x:Class="DromHub.Views.BrandPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:converters="using:DromHub.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:NullToBooleanConverter x:Key="NullToBooleanConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:NullToInvertedVisibilityConverter x:Key="NullToInvertedVisibilityConverter"/>

        <!-- Бейдж/тултип (2-сост. логика) -->
        <converters:BrandMarkupBadgeConverter x:Key="BrandMarkupBadgeConverter"/>
        <converters:BrandMarkupBadgeTooltipConverter x:Key="BrandMarkupBadgeTooltipConverter"/>

        <CollectionViewSource x:Key="BrandCvs"
                              Source="{Binding GroupedBrands}"
                              IsSourceGrouped="True"
                              ItemsPath="Items"/>
    </Page.Resources>

    <Grid Padding="12" RowSpacing="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Заголовок -->
        <StackPanel Grid.Row="0" Spacing="4">
            <TextBlock Text="Бренды" Style="{ThemeResource TitleTextBlockStyle}"/>
            <TextBlock Text="Просмотр и редактирование брендов, управление наценкой по бренду и работа с синонимами."
                       Style="{ThemeResource BodyTextBlockStyle}" Opacity="0.9"/>
        </StackPanel>

        <!-- Две колонки -->
        <Grid Grid.Row="1" ColumnSpacing="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="1"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- ===== Левая колонка ===== -->
            <Grid Grid.Column="0" RowSpacing="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Список брендов"
                           Style="{ThemeResource SubtitleTextBlockStyle}"/>

                <!-- Быстрые фильтры -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8">
                    <ToggleButton Content="OEM"               IsChecked="{Binding FilterIsOem,        Mode=TwoWay}"/>
                    <ToggleButton Content="С наценкой"        IsChecked="{Binding FilterWithMarkup,   Mode=TwoWay}"/>
                    <ToggleButton Content="Наценка выкл"      IsChecked="{Binding FilterMarkupOff,    Mode=TwoWay}"/>
                    <ToggleButton Content="Без алиасов"       IsChecked="{Binding FilterNoAliases,    Mode=TwoWay}"/>
                </StackPanel>

                <!-- Список + индекс внутри одного грида -->
                <Border Grid.Row="2" CornerRadius="8" BorderThickness="1"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                    <Grid x:Name="ListWithIndexGrid">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition x:Name="ListCol"     Width="*"/>
                            <ColumnDefinition x:Name="IndexSepCol" Width="1"/>
                            <ColumnDefinition x:Name="IndexCol"    Width="36"/>
                        </Grid.ColumnDefinitions>

                        <!-- сам список -->
                        <ListView x:Name="BrandsList"
                                  Grid.Column="0"
                                  ItemsSource="{Binding Source={StaticResource BrandCvs}}"
                                  SelectionMode="Single"
                                  SelectedItem="{Binding SelectedBrand, Mode=TwoWay}"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListView.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <!-- липкие заголовки групп -->
                                    <ItemsStackPanel AreStickyGroupHeadersEnabled="True"/>
                                </ItemsPanelTemplate>
                            </ListView.ItemsPanel>

                            <!-- ВАЖНО: растягиваем item по ширине, чтобы бейдж стоял справа -->
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="ContextFlyout">
                                        <Setter.Value>
                                            <MenuFlyout>
                                                <MenuFlyoutItem Text="Создать запчасть…" Click="CreatePart_Click"/>
                                                <MenuFlyoutItem Text="Объединить…"      Click="MergeBrands_Click"/>
                                            </MenuFlyout>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListView.ItemContainerStyle>

                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <!-- Имя + (кол-во) слева; бейдж-наценка справа -->
                                    <Grid ColumnDefinitions="*,Auto" Padding="8,4">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="{Binding Name}"/>
                                            <TextBlock Text="(" Opacity="0.6"/>
                                            <TextBlock Text="{Binding PartsCount}" Opacity="0.6"/>
                                            <TextBlock Text=")" Opacity="0.6"/>
                                        </StackPanel>

                                        <!-- в конвертер уходит весь Brand (2 состояния: N%/0%) -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Converter={StaticResource BrandMarkupBadgeConverter}}"
                                                   HorizontalAlignment="Right" Opacity="0.8">
                                            <ToolTipService.ToolTip>
                                                <TextBlock Text="{Binding Converter={StaticResource BrandMarkupBadgeTooltipConverter}}"/>
                                            </ToolTipService.ToolTip>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>

                            <ListView.GroupStyle>
                                <GroupStyle>
                                    <GroupStyle.HeaderTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Key}"
                                                       FontWeight="Bold" FontSize="16" Margin="8,8,8,4"/>
                                        </DataTemplate>
                                    </GroupStyle.HeaderTemplate>
                                </GroupStyle>
                            </ListView.GroupStyle>
                        </ListView>

                        <!-- разделитель -->
                        <Rectangle Grid.Column="1"
                                   Fill="{ThemeResource CardStrokeColorDefaultBrush}"/>

                        <!-- контейнер для букв (наполняем из code-behind) -->
                        <Grid x:Name="IndexHost"
                              Grid.Column="2"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"/>
                    </Grid>
                </Border>

                <!-- Кнопки под списком -->
                <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="8">
                    <Button Content="Добавить бренд"   Click="AddBrand_Click"    MinWidth="120" Padding="12,6"/>
                    <Button Content="Редактировать"    Click="EditBrand_Click"   MinWidth="140" Padding="12,6"
                            IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                    <Button Content="Удалить бренд"    Click="DeleteBrand_Click" MinWidth="120" Padding="12,6"
                            IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                </StackPanel>
            </Grid>

            <!-- разделитель колонок -->
            <Rectangle Grid.Column="1" Fill="{ThemeResource CardStrokeColorDefaultBrush}"/>

            <!-- ===== Правая колонка ===== -->
            <Grid Grid.Column="2" RowSpacing="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Наценка по бренду" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="12,0,0,0">
                        <Button Content="Создать запчасть…" Click="CreatePart_Click"
                                IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                        <Button Content="Объединить…" Click="MergeBrands_Click"
                                IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Карточка наценки (2 состояния: N% / 0%) -->
                <Border Grid.Row="1" CornerRadius="8" Padding="12"
                        BorderThickness="1" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                    <StackPanel Spacing="10">
                        <TextBlock Text="{Binding SelectedBrand.Name}"
                                   Style="{ThemeResource BodyStrongTextBlockStyle}"
                                   Visibility="{Binding SelectedBrand, Converter={StaticResource NullToVisibilityConverter}}"/>
                        <TextBlock Text="Бренд не выбран" Opacity="0.7"
                                   Visibility="{Binding SelectedBrand, Converter={StaticResource NullToInvertedVisibilityConverter}}"/>

                        <!-- Пресеты -->
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <Button Content="0%"  Tag="0"  Click="PresetMarkup_Click"/>
                            <Button Content="10%" Tag="10" Click="PresetMarkup_Click"/>
                            <Button Content="15%" Tag="15" Click="PresetMarkup_Click"/>
                            <Button Content="20%" Tag="20" Click="PresetMarkup_Click"/>
                            <Button Content="30%" Tag="30" Click="PresetMarkup_Click"/>
                        </StackPanel>

                        <!-- Точный ввод -->
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <controls:NumberBox Header="Значение, %"
                                                Value="{Binding BrandMarkupPercent, Mode=TwoWay}"
                                                Minimum="-100" Maximum="1000"
                                                SmallChange="1" LargeChange="10"
                                                SpinButtonPlacementMode="Compact"
                                                Width="140"/>
                            <TextBlock Text="%" VerticalAlignment="Bottom" Opacity="0.7"/>
                        </StackPanel>

                        <!-- Подсказка при 0% -->
                        <TextBlock Text="0% = наценка не применяется" Opacity="0.7"/>

                        <!-- Действия -->
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Сохранить"
                                    Command="{Binding SaveBrandMarkupCommand}"
                                    MinWidth="120" Padding="10,6"
                                    IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                            <Button Content="Сбросить"
                                    Command="{Binding ClearBrandMarkupCommand}"
                                    MinWidth="120" Padding="10,6"
                                    IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Диагностика -->
                <InfoBar Grid.Row="2" IsOpen="{Binding HasDiagnostics}" Severity="Warning"
                         Title="Диагностика" Message="{Binding DiagnosticsText}"/>

                <TextBlock Grid.Row="3" Text="Синонимы"
                           Style="{ThemeResource SubtitleTextBlockStyle}"/>

                <Border Grid.Row="4" CornerRadius="8" BorderThickness="1"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                    <ListView ItemsSource="{Binding Aliases}"
                              SelectedItem="{Binding SelectedAlias, Mode=TwoWay}"
                              ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsStackPanel/>
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding Alias}" Margin="0,0,12,0"
                                               FontWeight="{Binding IsPrimary, Converter={StaticResource BoolToFontWeightConverter}}"/>
                                    <TextBlock Text="{Binding Note}" Opacity="0.6"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Border>

                <!-- Undo + кнопки -->
                <StackPanel Grid.Row="5" Spacing="8">
                    <InfoBar x:Name="UndoBar"
                             IsOpen="False" Severity="Informational"
                             Title="Синоним удалён">
                        <InfoBar.ActionButton>
                            <Button Content="Отменить" Click="UndoDeleteAlias_Click"/>
                        </InfoBar.ActionButton>
                    </InfoBar>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Добавить синоним" Click="AddAlias_Click"
                                MinWidth="140" Padding="12,6"
                                IsEnabled="{Binding SelectedBrand, Converter={StaticResource NullToBooleanConverter}}"/>
                        <Button Content="Редактировать" Click="EditAlias_Click"
                                MinWidth="120" Padding="12,6"
                                IsEnabled="{Binding CanEditOrDeleteAlias}"/>
                        <Button Content="Удалить" Click="DeleteAlias_Click"
                                MinWidth="120" Padding="12,6"
                                IsEnabled="{Binding CanEditOrDeleteAlias}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</Page>